name: Send Webhook
on:
  push: {}
  pull_request:
    types: [opened, reopened, synchronize, closed]
  pull_request_review: {}
  issue_comment:
    types: [created]

jobs:
  main:
    runs-on: ubuntu-latest
    env:
      PAYLOAD: "${{ toJSON(github.event) }}"
    # if: ${{ github.event.issue.pull_request }}
    steps:
      - name: Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:atlantis

      - name: Print payload
        run: echo $PAYLOAD

      - name: Send webhook
        run: |
          USER_AGENT=$(openssl rand -hex 7)
          UUID=$(openssl rand -hex 16)
          REQUEST_ID=$(echo ${UUID:0:8}-${UUID:8:4}-${UUID:12:4}-${UUID:16:4}-${UUID:20:12})
          SHA1=$(echo -n "$PAYLOAD" | openssl dgst -sha1 -hmac '${{ secrets.ATLANTIS_SECRET}}' | sed 's/.*= //')
          SHA256=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac '${{ secrets.ATLANTIS_SECRET }}' | sed 's/.*= //')

          curl --http1.1 --fail-with-body -v -sS -X POST \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -H "User-Agent: GitHub-Hookshot/$USER_AGENT" \
            -H "X-GitHub-Delivery: $REQUEST_ID" \
            -H "X-Hub-Signature: sha1=$SHA1" \
            -H "X-Hub-Signature-256: sha256=$SHA256" \
            -H "X-GitHub-Event: ${{ github.event_name }}" \
            -H "X-GitHub-Hook-ID: 520185796" \
            -H "X-GitHub-Hook-Installation-Target-ID: 906973594" \
            -H "X-GitHub-Hook-Installation-Target-Type: repository" \
            --data "$PAYLOAD" \
            http://103.3.60.132:4141/events
